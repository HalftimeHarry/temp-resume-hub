name: Test Setup

on:
  workflow_dispatch:

jobs:
  test-setup:
    name: Test GitHub Actions Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check repository structure
        run: |
          echo "ğŸ“ Repository structure:"
          ls -la
          echo ""
          echo "ğŸ“ Backend directory:"
          ls -la backend/ || echo "âŒ Backend directory not found"
          echo ""
          echo "ğŸ“ GitHub workflows:"
          ls -la .github/workflows/ || echo "âŒ Workflows directory not found"

      - name: Check Dockerfile
        run: |
          echo "ğŸ³ Checking Dockerfile..."
          if [ -f "Dockerfile" ]; then
            echo "âœ… Root Dockerfile found"
            echo "ğŸ“„ Dockerfile content (first 10 lines):"
            head -10 Dockerfile
          else
            echo "âŒ Root Dockerfile not found"
          fi

      - name: Check backend files
        run: |
          echo "ğŸ” Checking backend files..."
          if [ -d "backend" ]; then
            echo "âœ… Backend directory exists"
            echo "ğŸ“ Backend contents:"
            ls -la backend/
            
            if [ -f "backend/pb_hooks/main.pb.js" ]; then
              echo "âœ… PocketBase hooks found"
            else
              echo "âŒ PocketBase hooks not found"
            fi
            
            if [ -f "backend/.env" ]; then
              echo "âœ… Environment file found"
            else
              echo "âŒ Environment file not found"
            fi
          else
            echo "âŒ Backend directory not found"
          fi

      - name: Test Railway token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ğŸ” Testing Railway token..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âŒ RAILWAY_TOKEN secret not set"
            echo "ğŸ“‹ To fix:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Add secret: RAILWAY_TOKEN = 53da0c89-bc1b-4f30-ab46-a82dd3416f3d"
          else
            echo "âœ… RAILWAY_TOKEN secret is set"
            echo "ğŸ”’ Token length: ${#RAILWAY_TOKEN} characters"
          fi

      - name: Install Railway CLI (test)
        run: |
          echo "ğŸš‚ Testing Railway CLI installation..."
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          
          # Test if Railway CLI works
          if command -v railway &> /dev/null; then
            echo "âœ… Railway CLI installed successfully"
            railway --version
          else
            echo "âŒ Railway CLI installation failed"
          fi

      - name: Test Railway login (dry run)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: 387321dc-13de-40a6-88b7-b6218716fb27
        run: |
          echo "ğŸ”‘ Testing Railway authentication..."
          if [ ! -z "$RAILWAY_TOKEN" ]; then
            # Test authentication via environment variable
            export RAILWAY_TOKEN=$RAILWAY_TOKEN
            export RAILWAY_PROJECT_ID=$RAILWAY_PROJECT_ID
            echo "âœ… Railway environment configured"
            echo "ğŸ”— Testing project access..."
            railway status && echo "âœ… Project access successful" || echo "âŒ Project access failed"
            echo "ğŸ“Š Project info:"
            echo "  Name: resourceful-patience"
            echo "  ID: 387321dc-13de-40a6-88b7-b6218716fb27"
          else
            echo "âš ï¸ Skipping Railway auth test - no token"
          fi

      - name: Setup summary
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ğŸ“‹ Setup Summary:"
          echo "=================="
          
          # Check each requirement
          if [ -f "Dockerfile" ]; then
            echo "âœ… Root Dockerfile: Present"
          else
            echo "âŒ Root Dockerfile: Missing"
          fi
          
          if [ -d "backend" ]; then
            echo "âœ… Backend directory: Present"
          else
            echo "âŒ Backend directory: Missing"
          fi
          
          if [ -f "backend/pb_hooks/main.pb.js" ]; then
            echo "âœ… PocketBase hooks: Present"
          else
            echo "âŒ PocketBase hooks: Missing"
          fi
          
          if [ ! -z "$RAILWAY_TOKEN" ]; then
            echo "âœ… Railway token: Configured"
          else
            echo "âŒ Railway token: Missing"
          fi
          
          if command -v railway &> /dev/null; then
            echo "âœ… Railway CLI: Working"
          else
            echo "âŒ Railway CLI: Failed"
          fi
          
          echo ""
          echo "ğŸ¯ Next Steps:"
          if [ -f "Dockerfile" ] && [ -d "backend" ] && [ ! -z "$RAILWAY_TOKEN" ]; then
            echo "âœ… Ready for deployment!"
            echo "ğŸš€ Run 'Manual Deploy to Railway' workflow"
          else
            echo "âš ï¸ Fix the issues above before deploying"
          fi